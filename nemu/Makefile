# Sanity check.检查src/nemu-main.c是否存在，不存在则报错
ifeq ($(wildcard $(NEMU_HOME)/src/nemu-main.c),)
  $(error NEMU_HOME=$(NEMU_HOME) is not a NEMU repo)
endif

# Include variables and rules generated by menuconfig
# 变量声明的引用
-include $(NEMU_HOME)/include/config/auto.conf
-include $(NEMU_HOME)/include/config/auto.conf.cmd

remove_quote = $(patsubst "%",%,$(1))

# Extract variabls from menuconfig
GUEST_ISA ?= $(call remove_quote,$(CONFIG_ISA))
ENGINE ?= $(call remove_quote,$(CONFIG_ENGINE))
NAME    = $(GUEST_ISA)-nemu-$(ENGINE)

# Include all filelist.mk to merge file lists
# 查找filelist.mk文件，把所有的filelist.mk中的可编译文件和在一起
FILELIST_MK = $(shell find ./src -name "filelist.mk")
include $(FILELIST_MK)

# Filter out directories and files in blacklist to obtain the final set of source files
# 从集合SRCS-y中删除集合SRCS-BLACKLIST-y，存储在SRCS里
DIRS-BLACKLIST-y += $(DIRS-BLACKLIST)
SRCS-BLACKLIST-y += $(SRCS-BLACKLIST) $(shell find $(DIRS-BLACKLIST-y) -name "*.c")
SRCS-y += $(shell find $(DIRS-y) -name "*.c")
SRCS = $(filter-out $(SRCS-BLACKLIST-y),$(SRCS-y))

# Extract compiler and options from menuconfig
#运行menuconfig,由nemu/Kconfig生成nemu/.config,从.config中找出编译器选项
#CFLAGS_BUILD 是编译阶段的通用编译选项，用于指定编译器的参数。例如，可以通过该变量设置优化级别、调试信息、代码优化等选项。
#CFLAGS_TRACE 是用于跟踪调试的特定编译选项。它通常用于在调试模式下开启额外的跟踪功能，如打印调试信息、记录运行时条件等。
CC = $(call remove_quote,$(CONFIG_CC))
CFLAGS_BUILD += $(call remove_quote,$(CONFIG_CC_OPT))
CFLAGS_BUILD += $(if $(CONFIG_CC_LTO),-flto,)#not set
CFLAGS_BUILD += $(if $(CONFIG_CC_DEBUG),-ggdb3,)
CFLAGS_BUILD += $(if $(CONFIG_CC_ASAN),-fsanitize=address,)#not set
CFLAGS_TRACE += -DITRACE_COND=$(if $(CONFIG_ITRACE_COND),$(call remove_quote,$(CONFIG_ITRACE_COND)),true)
#CFLAGS 是编译器的选项，用于设置编译阶段的参数。
CFLAGS  += $(CFLAGS_BUILD) $(CFLAGS_TRACE) -D__GUEST_ISA__=$(GUEST_ISA)
#LDFLAGS 是链接器的选项，用于设置链接阶段的参数。
LDFLAGS += $(CFLAGS_BUILD)

# Include rules for menuconfig
# Makefile的编译规则
include $(NEMU_HOME)/scripts/config.mk
# CONFIG_TARGET_AM not set
ifdef CONFIG_TARGET_AM
include $(AM_HOME)/Makefile
LINKAGE += $(ARCHIVES)
else
# Include rules to build NEMU
include $(NEMU_HOME)/scripts/native.mk
endif
